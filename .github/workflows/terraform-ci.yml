name: Terraform PR Checks

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

env:
  TERRAFORM_VERSION: 1.9.5

permissions:
  contents: read
  pull-requests: read

jobs:
  terraform-fmt:
    name: terraform fmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Check formatting (recursive)
        run: terraform fmt -check -recursive

  tflint:
    name: tflint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.59.1
      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ runner.os }}-${{ hashFiles('.tflint.hcl') }}
      - name: Run TFLint
        run: |
          tflint --init
          tflint -f compact

  terraform-validate:
    name: terraform validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Init (no backend)
        run: terraform init -backend=false
      - name: Validate
        run: terraform validate

  checkov:
    name: checkov
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          download_external_modules: true
          soft_fail: true
          skip_check: CKV_GIT_1

  github-copilot:
    name: github-copilot
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: GitHub Copilot Review
        run: echo "GitHub Copilot review placeholder - enable Copilot for PR reviews in repository settings"
